{% extends "base.html" %}

{% block title %}{{ code_info.title }} - {{ language|title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="code-viewer">
    <div class="code-header">
        <div>
            <h1>{{ code_info.title }}</h1>
            <p class="code-meta">{{ language|title }} ‚Ä¢ Created: {{ code_info.created_at[:10] }}</p>
            {% if code_info.encrypted %}
            <p class="code-meta encrypted-badge">üîí Encrypted File</p>
            {% endif %}
            {% if code_info.is_secret %}
            <p class="code-meta secret-badge">üîê Secret File</p>
            {% endif %}
            {% if code_info.description %}
            <p class="code-description">{{ code_info.description }}</p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{{ url_for('category', language=language) }}" class="btn btn-secondary">Back to {{ language|title }}</a>
            <button id="open-notes" class="btn btn-primary">üìù Notes</button>
            {% if github_repo and code_info.filename %}
            <a href="https://github.com/{{ github_repo }}/blob/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-secondary" target="_blank">üìÇ View on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/edit/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-primary" target="_blank">‚úèÔ∏è Edit on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/delete/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-danger" target="_blank" onclick="return confirm('This will take you to GitHub to delete this file. Continue?');">üóëÔ∏è Delete on GitHub</a>
            {% else %}
            <a href="{{ url_for('edit_code', language=language, code_id=code_id) }}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            <button id="delete-code" class="btn btn-danger">üóëÔ∏è Delete</button>
            {% endif %}
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìù Notes</h2>
                <button class="modal-close" onclick="closeNotesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button id="create-note-btn" class="btn btn-primary">‚ûï Create New Note</button>
                </div>
                <div id="notes-list"></div>
            </div>
        </div>
    </div>

    <!-- Note Editor Modal -->
    <div id="noteEditorModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="editor-title">Create Note</h2>
                <button class="modal-close" onclick="closeNoteEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm" onsubmit="saveNote(event)">
                    <div style="margin-bottom: 15px;">
                        <label for="note-title" style="display: block; margin-bottom: 5px; color: #00ff00;">Title:</label>
                        <input type="text" id="note-title" required style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid rgba(0, 255, 0, 0.3); color: #00ff00; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="note-content" style="display: block; margin-bottom: 5px; color: #00ff00;">Content:</label>
                        <textarea id="note-content" rows="8" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid rgba(0, 255, 0, 0.3); color: #00ff00; border-radius: 4px;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff00;">Screenshots:</label>
                        <input type="file" id="note-images" multiple accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('note-images').click()" class="btn btn-secondary">üì∑ Add Screenshots</button>
                        <div id="image-previews" style="margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">üíæ Save Note</button>
                        <button type="button" onclick="closeNoteEditor()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if code_info.encrypted and not code_content %}
    <!-- Password prompt for encrypted files -->
    <div class="encryption-prompt">
        <h2>üîí This file is encrypted</h2>
        <p>Please enter the password to view the content:</p>
        <div class="password-form">
            <input type="password" id="decrypt-password" placeholder="Enter password">
            <button id="decrypt-btn" class="btn btn-primary">Decrypt</button>
        </div>
        <div id="decrypt-error" class="error-message" style="display: none;"></div>
    </div>
    
    <div id="decrypted-content" style="display: none;">
    {% endif %}
    
    <div class="code-content">
        <h2>Code</h2>
        <div class="code-editor-wrapper">
            <textarea id="code-editor">{{ code_content if code_content else '' }}</textarea>
        </div>
    </div>

    <div class="execution-panel">
        <div class="execution-controls">
            <h2>Execute Code</h2>
            <button id="run-code" class="btn btn-primary">‚ñ∂Ô∏è Run Code</button>
            {% if language in ['c', 'cpp'] %}
            <button id="analyze-code" class="btn btn-secondary" style="margin-left: 10px;">ü§ñ AI Code Analysis</button>
            <button id="create-pr" class="btn btn-success" style="margin-left: 10px; display: none;">üöÄ Create PR with Refactored Code</button>
            {% endif %}
        </div>
        
        <div class="input-section">
            <label for="stdin-input">Input (stdin):</label>
            <textarea id="stdin-input" placeholder="Enter input for your program (optional)"></textarea>
        </div>

        <div class="output-section">
            <h3>Output</h3>
            <div id="output" class="output-display">
                <p class="output-placeholder">Click "Run Code" to see the output</p>
            </div>
        </div>
        
        {% if language in ['c', 'cpp'] %}
        <div class="analysis-section" id="analysis-section" style="display: none;">
            <h3>AI Code Analysis</h3>
            <div id="analysis-output" class="analysis-display"></div>
        </div>
        {% endif %}
    </div>
    
    {% if code_info.encrypted and not code_content %}
    </div>
    {% endif %}
</div>

<style>
.encrypted-badge, .secret-badge {
    display: inline-block;
    padding: 5px 10px;
    background: #f0f8ff;
    border: 1px solid #b3d9ff;
    border-radius: 4px;
    font-weight: bold;
    margin-top: 5px;
}

.secret-badge {
    background: #fff0f5;
    border-color: #ffb3d9;
}

.encryption-prompt {
    background: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

.password-form {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.password-form input {
    padding: 10px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

.error-message {
    color: #dc3545;
    margin-top: 15px;
    font-weight: bold;
}

.analysis-section {
    margin-top: 30px;
    background: #000000;
    border: 1px solid #00ff00;
    border-radius: 8px;
    padding: 20px;
}

.analysis-section h3 {
    color: #00ff00;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
}

.analysis-display {
    background: #0a0a0a;
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 15px;
    max-height: 600px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    white-space: pre-wrap;
    color: #00ff00;
}

.analysis-display h4 {
    color: #00ff00;
    text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
    margin-top: 15px;
    margin-bottom: 10px;
}

.analysis-display pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #00ff00;
}

.analysis-summary {
    background: rgba(0, 255, 0, 0.1);
    border-left: 4px solid #00ff00;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    color: #00ff00;
}

.analysis-summary strong {
    color: #00ff00;
}

.analysis-issue {
    background: rgba(255, 193, 7, 0.15);
    border-left: 4px solid #ffc107;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #ffc107;
}

.analysis-issue.critical {
    background: rgba(220, 53, 69, 0.15);
    border-left-color: #dc3545;
    color: #ff6b6b;
}

.analysis-issue.error {
    background: rgba(220, 53, 69, 0.15);
    border-left-color: #dc3545;
    color: #ff6b6b;
}

.analysis-suggestion {
    background: rgba(23, 162, 184, 0.15);
    border-left: 4px solid #17a2b8;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #17a2b8;
}

.analysis-alternative {
    background: rgba(40, 167, 69, 0.15);
    border-left: 4px solid #28a745;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #4dff4d;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.8);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #0a0a0a;
    border: 2px solid rgba(0, 255, 0, 0.5);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(0, 255, 0, 0.3);
}

.modal-header h2 {
    color: #00ff00;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: #00ff00;
    font-size: 2em;
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: #ff0000;
}

.modal-body {
    padding: 20px;
}

.note-card {
    background: rgba(0, 255, 0, 0.05);
    border: 1px solid rgba(0, 255, 0, 0.2);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.note-card:hover {
    background: rgba(0, 255, 0, 0.1);
    border-color: rgba(0, 255, 0, 0.5);
    transform: translateY(-2px);
}

.note-card h3 {
    color: #00ff00;
    margin: 0 0 10px 0;
}

.note-card p {
    color: #b0b0b0;
    margin: 5px 0;
    font-size: 0.9em;
}

.note-meta {
    color: #666;
    font-size: 0.8em;
}

.image-preview {
    position: relative;
    border: 1px solid rgba(0, 255, 0, 0.3);
    border-radius: 4px;
    overflow: hidden;
}

.image-preview img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}

.image-preview-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 0;
}

.image-preview-remove:hover {
    background: rgba(255, 0, 0, 1);
}

/* Practice Problems Styles */
.practice-problem {
    background: rgba(0, 100, 150, 0.1);
    border: 1px solid rgba(0, 150, 200, 0.3);
    border-radius: 8px;
    margin: 15px 0;
    overflow: hidden;
}

.practice-problem-header {
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 100, 150, 0.15);
    transition: background 0.3s;
}

.practice-problem-header:hover {
    background: rgba(0, 150, 200, 0.2);
}

.practice-problem-header h5 {
    color: #00d9ff;
    margin: 0;
    font-size: 1.1em;
}

.toggle-icon {
    color: #00d9ff;
    font-size: 1.2em;
    font-weight: bold;
}

.practice-problem-content {
    padding: 20px;
    border-top: 1px solid rgba(0, 150, 200, 0.3);
}

.practice-problem-content p {
    color: #b0b0b0;
    margin: 10px 0;
}

.practice-problem-content pre {
    background: rgba(0, 0, 0, 0.5);
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
}

.difficulty-easy {
    color: #4dff4d;
    font-size: 0.9em;
    font-weight: bold;
}

.difficulty-medium {
    color: #ffa500;
    font-size: 0.9em;
    font-weight: bold;
}

.difficulty-hard {
    color: #ff4444;
    font-size: 0.9em;
    font-weight: bold;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    // Initialize CodeMirror
    const languageModes = {
        'python': 'python',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'javascript': 'javascript',
        'typescript': 'text/typescript'
    };

    let editor;
    const isEncrypted = {{ 'true' if code_info.encrypted and not code_content else 'false' }};
    
    if (!isEncrypted) {
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: languageModes['{{ language }}'],
            theme: 'monokai',
            lineNumbers: true,
            readOnly: true,
            viewportMargin: Infinity
        });
    }

    // Handle decryption for encrypted files
    if (isEncrypted) {
        const decryptBtn = document.getElementById('decrypt-btn');
        const passwordInput = document.getElementById('decrypt-password');
        const errorDiv = document.getElementById('decrypt-error');
        const decryptedContent = document.getElementById('decrypted-content');
        
        async function decryptFile() {
            const password = passwordInput.value;
            
            if (!password) {
                errorDiv.textContent = 'Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.textContent = 'üîì Decrypting...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('{{ url_for("decrypt_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show decrypted content
                    document.querySelector('.encryption-prompt').style.display = 'none';
                    decryptedContent.style.display = 'block';
                    
                    // Initialize CodeMirror with decrypted content
                    const textarea = document.getElementById('code-editor');
                    textarea.value = data.content;
                    
                    editor = CodeMirror.fromTextArea(textarea, {
                        mode: languageModes['{{ language }}'],
                        theme: 'monokai',
                        lineNumbers: true,
                        readOnly: true,
                        viewportMargin: Infinity
                    });
                } else {
                    errorDiv.textContent = data.error || 'Decryption failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                decryptBtn.disabled = false;
                decryptBtn.textContent = 'Decrypt';
            }
        }
        
        decryptBtn.addEventListener('click', decryptFile);
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decryptFile();
            }
        });
    }

    // Execute code
    document.getElementById('run-code').addEventListener('click', async function() {
        const btn = this;
        const output = document.getElementById('output');
        const stdinInput = document.getElementById('stdin-input').value;
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';
        output.innerHTML = '<p class="output-loading">Executing code...</p>';

        try {
            const response = await fetch('{{ url_for("execute_code", language=language, code_id=code_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: stdinInput })
            });

            const data = await response.json();
            
            if (data.success) {
                output.innerHTML = '<pre>' + escapeHtml(data.output || 'No output') + '</pre>';
            } else {
                output.innerHTML = '<pre class="output-error">' + escapeHtml(data.error) + '</pre>';
            }
        } catch (error) {
            output.innerHTML = '<pre class="output-error">Error: ' + escapeHtml(error.message) + '</pre>';
        } finally {
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Run Code';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Toggle practice problem visibility
    function toggleProblem(index) {
        const content = document.getElementById('problem-' + index);
        const icon = document.getElementById('toggle-' + index);
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }

    // Delete code functionality (only used when GitHub integration is not available)
    const deleteBtn = document.getElementById('delete-code');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            if (!confirm('‚ö†Ô∏è Note: For GitHub-integrated repos, use "Delete on GitHub" button instead.\n\nThis will delete the file locally only. Continue?')) {
                return;
            }
            
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üóëÔ∏è Deleting...';
            
            try {
                const response = await fetch('{{ url_for("delete_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Code deleted successfully!');
                    window.location.href = '{{ url_for("category", language=language) }}';
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete code'));
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Delete';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete';
            }
        });
    }

    // AI Code Analysis functionality (only for C/C++)
    {% if language in ['c', 'cpp'] %}
    const analyzeBtn = document.getElementById('analyze-code');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
            const btn = this;
            const analysisSection = document.getElementById('analysis-section');
            const analysisOutput = document.getElementById('analysis-output');
            
            btn.disabled = true;
            btn.textContent = 'ü§ñ Analyzing...';
            analysisSection.style.display = 'block';
            analysisOutput.innerHTML = '<p>Analyzing your code...</p>';
            
            try {
                const response = await fetch('{{ url_for("analyze_code_route", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Format the analysis results
                    const analysis = data.analysis;
                    let html = '';
                    
                    // Summary
                    html += '<div class="analysis-summary">';
                    html += '<h4>üìä Analysis Summary</h4>';
                    html += '<p><strong>Total Issues:</strong> ' + analysis.summary.total_issues + '</p>';
                    html += '<p><strong>Critical:</strong> ' + analysis.summary.critical + ' | ';
                    html += '<strong>Errors:</strong> ' + analysis.summary.errors + ' | ';
                    html += '<strong>Warnings:</strong> ' + analysis.summary.warnings + '</p>';
                    html += '<p><strong>Suggestions:</strong> ' + analysis.summary.suggestions + '</p>';
                    html += '<p><strong>Alternative Approaches:</strong> ' + analysis.summary.alternatives + '</p>';
                    html += '</div>';
                    
                    // Issues
                    if (analysis.issues && analysis.issues.length > 0) {
                        html += '<h4>üî¥ Issues Found</h4>';
                        analysis.issues.forEach((issue, idx) => {
                            const severity = issue.severity || 'warning';
                            html += '<div class="analysis-issue ' + severity + '">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + severity.toUpperCase() + '] ' + (issue.type || 'general').toUpperCase() + '</strong></p>';
                            if (issue.line) {
                                html += '<p><em>Line: ' + issue.line + '</em></p>';
                            }
                            html += '<p>‚ö†Ô∏è ' + escapeHtml(issue.message) + '</p>';
                            html += '<p>üí° <strong>Fix:</strong> ' + escapeHtml(issue.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Suggestions
                    if (analysis.suggestions && analysis.suggestions.length > 0) {
                        html += '<h4>üí° Suggestions for Improvement</h4>';
                        analysis.suggestions.forEach((suggestion, idx) => {
                            html += '<div class="analysis-suggestion">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + (suggestion.type || 'general').toUpperCase() + ']</strong></p>';
                            if (suggestion.line) {
                                html += '<p><em>Line: ' + suggestion.line + '</em></p>';
                            }
                            html += '<p>' + escapeHtml(suggestion.message) + '</p>';
                            html += '<p><strong>Suggestion:</strong> ' + escapeHtml(suggestion.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Alternatives
                    if (analysis.alternatives && analysis.alternatives.length > 0) {
                        html += '<h4>üîÑ Alternative Approaches & Recommended Code</h4>';
                        analysis.alternatives.forEach((alt, idx) => {
                            html += '<div class="analysis-alternative">';
                            html += '<p><strong>#' + (idx + 1) + ' ' + escapeHtml(alt.approach) + '</strong></p>';
                            html += '<p><strong>Benefit:</strong> ' + escapeHtml(alt.benefit) + '</p>';
                            html += '<p><strong>Example:</strong> <code>' + escapeHtml(alt.example) + '</code></p>';
                            if (alt.recommended_code) {
                                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 4px;">';
                                html += '<p><strong>üí° Recommended Code:</strong></p>';
                                html += '<pre style="color: #4dff4d; margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;">' + escapeHtml(alt.recommended_code) + '</pre>';
                                html += '</div>';
                            }
                            html += '</div>';
                        });
                    }
                    
                    // Practice Problems
                    if (analysis.practice_problems && analysis.practice_problems.length > 0) {
                        html += '<h4>üìö Practice Problems (Learn by Doing!)</h4>';
                        html += '<p style="color: #b0b0b0; margin-bottom: 15px;">Here are 5 similar problems to help you master these concepts:</p>';
                        
                        analysis.practice_problems.forEach((problem, idx) => {
                            html += '<div class="practice-problem">';
                            html += '<div class="practice-problem-header" onclick="toggleProblem(' + idx + ')">';
                            html += '<h5>üìù ' + escapeHtml(problem.title) + ' <span class="difficulty-' + problem.difficulty.toLowerCase() + '">[' + problem.difficulty + ']</span></h5>';
                            html += '<span class="toggle-icon" id="toggle-' + idx + '">‚ñº</span>';
                            html += '</div>';
                            html += '<div class="practice-problem-content" id="problem-' + idx + '" style="display: none;">';
                            html += '<p><strong>Description:</strong> ' + escapeHtml(problem.description) + '</p>';
                            html += '<div style="margin-top: 10px; padding: 15px; background: rgba(0, 100, 0, 0.2); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 4px;">';
                            html += '<p><strong>‚úÖ Complete Solution:</strong></p>';
                            html += '<pre style="color: #4dff4d; margin: 10px 0; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.4;">' + escapeHtml(problem.solution) + '</pre>';
                            html += '</div>';
                            if (problem.explanation) {
                                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 100, 0.2); border-left: 3px solid #17a2b8;">';
                                html += '<p><strong>üí° Explanation:</strong> ' + escapeHtml(problem.explanation) + '</p>';
                                html += '</div>';
                            }
                            html += '</div>';
                            html += '</div>';
                        });
                    }
                    
                    if (analysis.summary.total_issues === 0 && analysis.summary.suggestions === 0 && analysis.summary.alternatives === 0) {
                        html += '<p>‚úÖ No issues found! Your code looks good.</p>';
                    }
                    
                    analysisOutput.innerHTML = html;
                    
                    // Show Create PR button if there are improvements to be made
                    const hasRefactoredVersion = analysis.alternatives && analysis.alternatives.some(alt => 
                        alt.approach && alt.approach.includes('üéØ Complete Refactored Version')
                    );
                    
                    if (hasRefactoredVersion) {
                        const createPrBtn = document.getElementById('create-pr');
                        if (createPrBtn) {
                            createPrBtn.style.display = 'inline-block';
                        }
                    }
                } else {
                    analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(data.error || 'Analysis failed') + '</p>';
                }
            } catch (error) {
                analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(error.message) + '</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ AI Code Analysis';
            }
        });
    }
    
    // Create PR functionality
    const createPrBtn = document.getElementById('create-pr');
    if (createPrBtn) {
        createPrBtn.addEventListener('click', async function() {
            if (!confirm('üöÄ Create a Pull Request with AI-refactored code?\n\nThis will:\n1. Analyze your code\n2. Apply all suggested improvements\n3. Create a new branch\n4. Open a pull request on GitHub\n\nYou can review and merge the PR at your convenience.')) {
                return;
            }
            
            const btn = this;
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Creating PR...';
            
            try {
                const response = await fetch('{{ url_for("create_pr_with_refactored_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message with PR link
                    const message = `‚úÖ Pull Request Created Successfully!\n\nPR #${data.pr_number}\nBranch: ${data.branch}\n\nClick OK to open the PR on GitHub.`;
                    if (confirm(message)) {
                        window.open(data.pr_url, '_blank');
                    }
                    
                    // Also display the link in the analysis section
                    const analysisOutput = document.getElementById('analysis-output');
                    const prLink = `<div style="margin-top: 20px; padding: 15px; background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745; border-radius: 8px;">
                        <h4 style="color: #4dff4d; margin-top: 0;">‚úÖ Pull Request Created!</h4>
                        <p><strong>PR #${data.pr_number}</strong></p>
                        <p>Branch: <code>${data.branch}</code></p>
                        <p><a href="${data.pr_url}" target="_blank" style="color: #4dff4d; text-decoration: underline;">üîó View Pull Request on GitHub</a></p>
                    </div>`;
                    analysisOutput.innerHTML += prLink;
                    
                    // Hide the button after successful creation
                    btn.style.display = 'none';
                } else {
                    alert('‚ùå Error creating PR: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    }
    {% endif %}

    // ==================== Notes Functionality ====================
    let currentNoteId = null;
    let noteImages = [];

    // Open notes modal
    document.getElementById('open-notes').addEventListener('click', function() {
        openNotesModal();
    });

    async function openNotesModal() {
        document.getElementById('notesModal').classList.add('active');
        await loadNotes();
    }

    function closeNotesModal() {
        document.getElementById('notesModal').classList.remove('active');
    }

    async function loadNotes() {
        const notesList = document.getElementById('notes-list');
        notesList.innerHTML = '<p style="color: #00ff00;">Loading notes...</p>';

        try {
            const response = await fetch('/api/notes');
            const data = await response.json();

            if (data.success && data.notes.length > 0) {
                let html = '';
                if (data.kv_enabled) {
                    html += '<p style="color: #4dff4d; margin-bottom: 15px;">‚úÖ Using Vercel KV storage (server-side)</p>';
                } else {
                    html += '<p style="color: #ffa500; margin-bottom: 15px;">‚ö†Ô∏è Using local storage (will reset on refresh)</p>';
                }
                
                data.notes.forEach(note => {
                    const date = note.modified ? new Date(note.modified * 1000).toLocaleString() : 'Unknown';
                    html += `
                        <div class="note-card" onclick="viewNote('${note.id}')">
                            <h3>${escapeHtml(note.title)}</h3>
                            <p>${escapeHtml(note.content.substring(0, 100))}${note.content.length > 100 ? '...' : ''}</p>
                            <p class="note-meta">
                                üìÖ ${date} | 
                                üì∑ ${note.image_count} screenshot(s)
                            </p>
                        </div>
                    `;
                });

                notesList.innerHTML = html;
            } else {
                notesList.innerHTML = '<p style="color: #b0b0b0;">No notes yet. Create your first note!</p>';
            }
        } catch (error) {
            notesList.innerHTML = `<p style="color: #ff0000;">Error loading notes: ${escapeHtml(error.message)}</p>`;
        }
    }

    document.getElementById('create-note-btn').addEventListener('click', function() {
        currentNoteId = null;
        noteImages = [];
        document.getElementById('editor-title').textContent = 'Create Note';
        document.getElementById('noteForm').reset();
        document.getElementById('image-previews').innerHTML = '';
        document.getElementById('noteEditorModal').classList.add('active');
    });

    function closeNoteEditor() {
        document.getElementById('noteEditorModal').classList.remove('active');
        currentNoteId = null;
        noteImages = [];
    }

    async function viewNote(noteId) {
        try {
            const response = await fetch(`/api/notes/${noteId}`);
            const data = await response.json();

            if (data.success) {
                currentNoteId = noteId;
                noteImages = data.note.images || [];
                
                document.getElementById('editor-title').textContent = 'Edit Note';
                document.getElementById('note-title').value = data.note.title;
                document.getElementById('note-content').value = data.note.content;
                
                // Display existing images
                const imagePreviews = document.getElementById('image-previews');
                imagePreviews.innerHTML = '';
                noteImages.forEach((img, index) => {
                    const preview = createImagePreview(img.dataUrl, img.name, index);
                    imagePreviews.appendChild(preview);
                });

                document.getElementById('notesModal').classList.remove('active');
                document.getElementById('noteEditorModal').classList.add('active');
            }
        } catch (error) {
            alert('Error loading note: ' + error.message);
        }
    }

    // Handle image selection
    document.getElementById('note-images').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = {
                        name: file.name,
                        dataUrl: event.target.result
                    };
                    noteImages.push(img);
                    
                    const preview = createImagePreview(img.dataUrl, img.name, noteImages.length - 1);
                    document.getElementById('image-previews').appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        });

        // Reset input
        e.target.value = '';
    });

    function createImagePreview(dataUrl, name, index) {
        const div = document.createElement('div');
        div.className = 'image-preview';
        
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = name;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'image-preview-remove';
        removeBtn.innerHTML = '&times;';
        removeBtn.type = 'button';
        removeBtn.onclick = function(e) {
            e.stopPropagation();
            noteImages.splice(index, 1);
            div.remove();
            // Rebuild previews to fix indices
            rebuildImagePreviews();
        };
        
        div.appendChild(img);
        div.appendChild(removeBtn);
        
        return div;
    }

    function rebuildImagePreviews() {
        const imagePreviews = document.getElementById('image-previews');
        imagePreviews.innerHTML = '';
        noteImages.forEach((img, index) => {
            const preview = createImagePreview(img.dataUrl, img.name, index);
            imagePreviews.appendChild(preview);
        });
    }

    async function saveNote(event) {
        event.preventDefault();

        const title = document.getElementById('note-title').value.trim();
        const content = document.getElementById('note-content').value.trim();

        if (!title) {
            alert('Please enter a title');
            return;
        }

        const noteData = {
            title: title,
            content: content,
            images: noteImages
        };

        try {
            let response;
            if (currentNoteId) {
                // Update existing note
                response = await fetch(`/api/notes/${currentNoteId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(noteData)
                });
            } else {
                // Create new note
                response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(noteData)
                });
            }

            const data = await response.json();

            if (data.success) {
                alert(currentNoteId ? 'Note updated!' : 'Note created!');
                closeNoteEditor();
                openNotesModal();
            } else {
                alert('Error: ' + (data.error || 'Failed to save note'));
            }
        } catch (error) {
            alert('Error saving note: ' + error.message);
        }
    }

</script>
{% endblock %}
