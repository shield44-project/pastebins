{% extends "base.html" %}

{% block title %}{{ code_info.title }} - {{ language|title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="code-viewer">
    <div class="code-header">
        <div>
            <h1>{{ code_info.title }}</h1>
            <p class="code-meta">{{ language|title }} ‚Ä¢ Created: {{ code_info.created_at[:10] }}</p>
            {% if code_info.encrypted %}
            <p class="code-meta encrypted-badge">üîí Encrypted File</p>
            {% endif %}
            {% if code_info.is_secret %}
            <p class="code-meta secret-badge">üîê Secret File</p>
            {% endif %}
            {% if code_info.description %}
            <p class="code-description">{{ code_info.description }}</p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('category', language=language) }}" class="btn btn-secondary">Back to {{ language|title }}</a>
            {% if github_repo and code_info.filename %}
            <a href="https://github.com/{{ github_repo }}/blob/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-secondary" target="_blank">üìÇ View on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/edit/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-primary" target="_blank">‚úèÔ∏è Edit on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/delete/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-danger" target="_blank" onclick="return confirm('This will take you to GitHub to delete this file. Continue?');">üóëÔ∏è Delete on GitHub</a>
            {% else %}
            <a href="{{ url_for('edit_code', language=language, code_id=code_id) }}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            <button id="delete-code" class="btn btn-danger">üóëÔ∏è Delete</button>
            {% endif %}
        </div>
    </div>

    {% if code_info.encrypted and not code_content %}
    <!-- Password prompt for encrypted files -->
    <div class="encryption-prompt">
        <h2>üîí This file is encrypted</h2>
        <p>Please enter the password to view the content:</p>
        <div class="password-form">
            <input type="password" id="decrypt-password" placeholder="Enter password">
            <button id="decrypt-btn" class="btn btn-primary">Decrypt</button>
        </div>
        <div id="decrypt-error" class="error-message" style="display: none;"></div>
    </div>
    
    <div id="decrypted-content" style="display: none;">
    {% endif %}
    
    <div class="code-content">
        <h2>Code</h2>
        <div class="code-editor-wrapper">
            <textarea id="code-editor">{{ code_content if code_content else '' }}</textarea>
        </div>
    </div>

    <div class="execution-panel">
        <div class="execution-controls">
            <h2>Execute Code</h2>
            <button id="run-code" class="btn btn-primary">‚ñ∂Ô∏è Run Code</button>
            {% if language in ['c', 'cpp'] %}
            <button id="analyze-code" class="btn btn-secondary" style="margin-left: 10px;">ü§ñ AI Code Analysis</button>
            <button id="create-pr" class="btn btn-success" style="margin-left: 10px; display: none;">üöÄ Create PR with Refactored Code</button>
            {% endif %}
        </div>
        
        <div class="input-section">
            <label for="stdin-input">Input (stdin):</label>
            <textarea id="stdin-input" placeholder="Enter input for your program (optional)"></textarea>
        </div>

        <div class="output-section">
            <h3>Output</h3>
            <div id="output" class="output-display">
                <p class="output-placeholder">Click "Run Code" to see the output</p>
            </div>
        </div>
        
        {% if language in ['c', 'cpp'] %}
        <div class="analysis-section" id="analysis-section" style="display: none;">
            <h3>AI Code Analysis</h3>
            <div id="analysis-output" class="analysis-display"></div>
        </div>
        {% endif %}
    </div>
    
    {% if code_info.encrypted and not code_content %}
    </div>
    {% endif %}
</div>

<style>
.encrypted-badge, .secret-badge {
    display: inline-block;
    padding: 5px 10px;
    background: #f0f8ff;
    border: 1px solid #b3d9ff;
    border-radius: 4px;
    font-weight: bold;
    margin-top: 5px;
}

.secret-badge {
    background: #fff0f5;
    border-color: #ffb3d9;
}

.encryption-prompt {
    background: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

.password-form {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.password-form input {
    padding: 10px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

.error-message {
    color: #dc3545;
    margin-top: 15px;
    font-weight: bold;
}

.analysis-section {
    margin-top: 30px;
    background: #000000;
    border: 1px solid #00ff00;
    border-radius: 8px;
    padding: 20px;
}

.analysis-section h3 {
    color: #00ff00;
    text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
}

.analysis-display {
    background: #0a0a0a;
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 15px;
    max-height: 600px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    white-space: pre-wrap;
    color: #00ff00;
}

.analysis-display h4 {
    color: #00ff00;
    text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
    margin-top: 15px;
    margin-bottom: 10px;
}

.analysis-display pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: #00ff00;
}

.analysis-summary {
    background: rgba(0, 255, 0, 0.1);
    border-left: 4px solid #00ff00;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    color: #00ff00;
}

.analysis-summary strong {
    color: #00ff00;
}

.analysis-issue {
    background: rgba(255, 193, 7, 0.15);
    border-left: 4px solid #ffc107;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #ffc107;
}

.analysis-issue.critical {
    background: rgba(220, 53, 69, 0.15);
    border-left-color: #dc3545;
    color: #ff6b6b;
}

.analysis-issue.error {
    background: rgba(220, 53, 69, 0.15);
    border-left-color: #dc3545;
    color: #ff6b6b;
}

.analysis-suggestion {
    background: rgba(23, 162, 184, 0.15);
    border-left: 4px solid #17a2b8;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #17a2b8;
}

.analysis-alternative {
    background: rgba(40, 167, 69, 0.15);
    border-left: 4px solid #28a745;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    color: #4dff4d;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    // Initialize CodeMirror
    const languageModes = {
        'python': 'python',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'javascript': 'javascript',
        'typescript': 'text/typescript'
    };

    let editor;
    const isEncrypted = {{ 'true' if code_info.encrypted and not code_content else 'false' }};
    
    if (!isEncrypted) {
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: languageModes['{{ language }}'],
            theme: 'monokai',
            lineNumbers: true,
            readOnly: true,
            viewportMargin: Infinity
        });
    }

    // Handle decryption for encrypted files
    if (isEncrypted) {
        const decryptBtn = document.getElementById('decrypt-btn');
        const passwordInput = document.getElementById('decrypt-password');
        const errorDiv = document.getElementById('decrypt-error');
        const decryptedContent = document.getElementById('decrypted-content');
        
        async function decryptFile() {
            const password = passwordInput.value;
            
            if (!password) {
                errorDiv.textContent = 'Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.textContent = 'üîì Decrypting...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('{{ url_for("decrypt_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show decrypted content
                    document.querySelector('.encryption-prompt').style.display = 'none';
                    decryptedContent.style.display = 'block';
                    
                    // Initialize CodeMirror with decrypted content
                    const textarea = document.getElementById('code-editor');
                    textarea.value = data.content;
                    
                    editor = CodeMirror.fromTextArea(textarea, {
                        mode: languageModes['{{ language }}'],
                        theme: 'monokai',
                        lineNumbers: true,
                        readOnly: true,
                        viewportMargin: Infinity
                    });
                } else {
                    errorDiv.textContent = data.error || 'Decryption failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                decryptBtn.disabled = false;
                decryptBtn.textContent = 'Decrypt';
            }
        }
        
        decryptBtn.addEventListener('click', decryptFile);
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decryptFile();
            }
        });
    }

    // Execute code
    document.getElementById('run-code').addEventListener('click', async function() {
        const btn = this;
        const output = document.getElementById('output');
        const stdinInput = document.getElementById('stdin-input').value;
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';
        output.innerHTML = '<p class="output-loading">Executing code...</p>';

        try {
            const response = await fetch('{{ url_for("execute_code", language=language, code_id=code_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: stdinInput })
            });

            const data = await response.json();
            
            if (data.success) {
                output.innerHTML = '<pre>' + escapeHtml(data.output || 'No output') + '</pre>';
            } else {
                output.innerHTML = '<pre class="output-error">' + escapeHtml(data.error) + '</pre>';
            }
        } catch (error) {
            output.innerHTML = '<pre class="output-error">Error: ' + escapeHtml(error.message) + '</pre>';
        } finally {
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Run Code';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Delete code functionality (only used when GitHub integration is not available)
    const deleteBtn = document.getElementById('delete-code');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            if (!confirm('‚ö†Ô∏è Note: For GitHub-integrated repos, use "Delete on GitHub" button instead.\n\nThis will delete the file locally only. Continue?')) {
                return;
            }
            
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üóëÔ∏è Deleting...';
            
            try {
                const response = await fetch('{{ url_for("delete_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Code deleted successfully!');
                    window.location.href = '{{ url_for("category", language=language) }}';
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete code'));
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Delete';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete';
            }
        });
    }

    // AI Code Analysis functionality (only for C/C++)
    {% if language in ['c', 'cpp'] %}
    const analyzeBtn = document.getElementById('analyze-code');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
            const btn = this;
            const analysisSection = document.getElementById('analysis-section');
            const analysisOutput = document.getElementById('analysis-output');
            
            btn.disabled = true;
            btn.textContent = 'ü§ñ Analyzing...';
            analysisSection.style.display = 'block';
            analysisOutput.innerHTML = '<p>Analyzing your code...</p>';
            
            try {
                const response = await fetch('{{ url_for("analyze_code_route", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Format the analysis results
                    const analysis = data.analysis;
                    let html = '';
                    
                    // Summary
                    html += '<div class="analysis-summary">';
                    html += '<h4>üìä Analysis Summary</h4>';
                    html += '<p><strong>Total Issues:</strong> ' + analysis.summary.total_issues + '</p>';
                    html += '<p><strong>Critical:</strong> ' + analysis.summary.critical + ' | ';
                    html += '<strong>Errors:</strong> ' + analysis.summary.errors + ' | ';
                    html += '<strong>Warnings:</strong> ' + analysis.summary.warnings + '</p>';
                    html += '<p><strong>Suggestions:</strong> ' + analysis.summary.suggestions + '</p>';
                    html += '<p><strong>Alternative Approaches:</strong> ' + analysis.summary.alternatives + '</p>';
                    html += '</div>';
                    
                    // Issues
                    if (analysis.issues && analysis.issues.length > 0) {
                        html += '<h4>üî¥ Issues Found</h4>';
                        analysis.issues.forEach((issue, idx) => {
                            const severity = issue.severity || 'warning';
                            html += '<div class="analysis-issue ' + severity + '">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + severity.toUpperCase() + '] ' + (issue.type || 'general').toUpperCase() + '</strong></p>';
                            if (issue.line) {
                                html += '<p><em>Line: ' + issue.line + '</em></p>';
                            }
                            html += '<p>‚ö†Ô∏è ' + escapeHtml(issue.message) + '</p>';
                            html += '<p>üí° <strong>Fix:</strong> ' + escapeHtml(issue.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Suggestions
                    if (analysis.suggestions && analysis.suggestions.length > 0) {
                        html += '<h4>üí° Suggestions for Improvement</h4>';
                        analysis.suggestions.forEach((suggestion, idx) => {
                            html += '<div class="analysis-suggestion">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + (suggestion.type || 'general').toUpperCase() + ']</strong></p>';
                            if (suggestion.line) {
                                html += '<p><em>Line: ' + suggestion.line + '</em></p>';
                            }
                            html += '<p>' + escapeHtml(suggestion.message) + '</p>';
                            html += '<p><strong>Suggestion:</strong> ' + escapeHtml(suggestion.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Alternatives
                    if (analysis.alternatives && analysis.alternatives.length > 0) {
                        html += '<h4>üîÑ Alternative Approaches & Recommended Code</h4>';
                        analysis.alternatives.forEach((alt, idx) => {
                            html += '<div class="analysis-alternative">';
                            html += '<p><strong>#' + (idx + 1) + ' ' + escapeHtml(alt.approach) + '</strong></p>';
                            html += '<p><strong>Benefit:</strong> ' + escapeHtml(alt.benefit) + '</p>';
                            html += '<p><strong>Example:</strong> <code>' + escapeHtml(alt.example) + '</code></p>';
                            if (alt.recommended_code) {
                                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 4px;">';
                                html += '<p><strong>üí° Recommended Code:</strong></p>';
                                html += '<pre style="color: #4dff4d; margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;">' + escapeHtml(alt.recommended_code) + '</pre>';
                                html += '</div>';
                            }
                            html += '</div>';
                        });
                    }
                    
                    if (analysis.summary.total_issues === 0 && analysis.summary.suggestions === 0 && analysis.summary.alternatives === 0) {
                        html += '<p>‚úÖ No issues found! Your code looks good.</p>';
                    }
                    
                    analysisOutput.innerHTML = html;
                    
                    // Show Create PR button if there are improvements to be made
                    const hasRefactoredVersion = analysis.alternatives && analysis.alternatives.some(alt => 
                        alt.approach && alt.approach.includes('üéØ Complete Refactored Version')
                    );
                    
                    if (hasRefactoredVersion) {
                        const createPrBtn = document.getElementById('create-pr');
                        if (createPrBtn) {
                            createPrBtn.style.display = 'inline-block';
                        }
                    }
                } else {
                    analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(data.error || 'Analysis failed') + '</p>';
                }
            } catch (error) {
                analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(error.message) + '</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ AI Code Analysis';
            }
        });
    }
    
    // Create PR functionality
    const createPrBtn = document.getElementById('create-pr');
    if (createPrBtn) {
        createPrBtn.addEventListener('click', async function() {
            if (!confirm('üöÄ Create a Pull Request with AI-refactored code?\n\nThis will:\n1. Analyze your code\n2. Apply all suggested improvements\n3. Create a new branch\n4. Open a pull request on GitHub\n\nYou can review and merge the PR at your convenience.')) {
                return;
            }
            
            const btn = this;
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Creating PR...';
            
            try {
                const response = await fetch('{{ url_for("create_pr_with_refactored_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message with PR link
                    const message = `‚úÖ Pull Request Created Successfully!\n\nPR #${data.pr_number}\nBranch: ${data.branch}\n\nClick OK to open the PR on GitHub.`;
                    if (confirm(message)) {
                        window.open(data.pr_url, '_blank');
                    }
                    
                    // Also display the link in the analysis section
                    const analysisOutput = document.getElementById('analysis-output');
                    const prLink = `<div style="margin-top: 20px; padding: 15px; background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745; border-radius: 8px;">
                        <h4 style="color: #4dff4d; margin-top: 0;">‚úÖ Pull Request Created!</h4>
                        <p><strong>PR #${data.pr_number}</strong></p>
                        <p>Branch: <code>${data.branch}</code></p>
                        <p><a href="${data.pr_url}" target="_blank" style="color: #4dff4d; text-decoration: underline;">üîó View Pull Request on GitHub</a></p>
                    </div>`;
                    analysisOutput.innerHTML += prLink;
                    
                    // Hide the button after successful creation
                    btn.style.display = 'none';
                } else {
                    alert('‚ùå Error creating PR: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    }
    {% endif %}

</script>
{% endblock %}
