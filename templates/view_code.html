{% extends "base.html" %}

{% block title %}{{ code_info.title }} - {{ language|title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="code-viewer">
    <div class="code-header">
        <div>
            <h1>{{ code_info.title }}</h1>
            <p class="code-meta">{{ language|title }} ‚Ä¢ Created: {{ code_info.created_at[:10] }}</p>
            {% if code_info.encrypted %}
            <p class="code-meta encrypted-badge">üîí Encrypted File</p>
            {% endif %}
            {% if code_info.is_secret %}
            <p class="code-meta secret-badge">üîê Secret File</p>
            {% endif %}
            {% if code_info.description %}
            <p class="code-description">{{ code_info.description }}</p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('category', language=language) }}" class="btn btn-secondary">Back to {{ language|title }}</a>
            {% if github_repo and code_info.filename %}
            <a href="https://github.com/{{ github_repo }}/blob/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-secondary" target="_blank">üìÇ View on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/edit/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-primary" target="_blank">‚úèÔ∏è Edit on GitHub</a>
            <a href="https://github.com/{{ github_repo }}/delete/{{ github_branch }}/stored_codes/{{ language }}/{{ code_info.filename }}{% if code_info.encrypted %}.enc{% endif %}" class="btn btn-danger" target="_blank" onclick="return confirm('This will take you to GitHub to delete this file. Continue?');">üóëÔ∏è Delete on GitHub</a>
            {% else %}
            <a href="{{ url_for('edit_code', language=language, code_id=code_id) }}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            <button id="delete-code" class="btn btn-danger">üóëÔ∏è Delete</button>
            {% endif %}
        </div>
    </div>

    {% if code_info.encrypted and not code_content %}
    <!-- Password prompt for encrypted files -->
    <div class="encryption-prompt">
        <h2>üîí This file is encrypted</h2>
        <p>Please enter the password to view the content:</p>
        <div class="password-form">
            <input type="password" id="decrypt-password" placeholder="Enter password">
            <button id="decrypt-btn" class="btn btn-primary">Decrypt</button>
        </div>
        <div id="decrypt-error" class="error-message" style="display: none;"></div>
    </div>
    
    <div id="decrypted-content" style="display: none;">
    {% endif %}
    
    <div class="code-content">
        <h2>Code</h2>
        <div class="code-editor-wrapper">
            <textarea id="code-editor">{{ code_content if code_content else '' }}</textarea>
        </div>
    </div>

    <div class="execution-panel">
        <div class="execution-controls">
            <h2>Execute Code</h2>
            <button id="run-code" class="btn btn-primary">‚ñ∂Ô∏è Run Code</button>
            {% if language in ['c', 'cpp'] %}
            <button id="analyze-code" class="btn btn-secondary" style="margin-left: 10px;">ü§ñ AI Code Analysis</button>
            {% endif %}
        </div>
        
        <div class="input-section">
            <label for="stdin-input">Input (stdin):</label>
            <textarea id="stdin-input" placeholder="Enter input for your program (optional)"></textarea>
        </div>

        <div class="output-section">
            <h3>Output</h3>
            <div id="output" class="output-display">
                <p class="output-placeholder">Click "Run Code" to see the output</p>
            </div>
        </div>
        
        {% if language in ['c', 'cpp'] %}
        <div class="analysis-section" id="analysis-section" style="display: none;">
            <h3>AI Code Analysis</h3>
            <div id="analysis-output" class="analysis-display"></div>
        </div>
        {% endif %}
    </div>
    
    {% if code_info.encrypted and not code_content %}
    </div>
    {% endif %}
</div>

<style>
.encrypted-badge, .secret-badge {
    display: inline-block;
    padding: 5px 10px;
    background: #f0f8ff;
    border: 1px solid #b3d9ff;
    border-radius: 4px;
    font-weight: bold;
    margin-top: 5px;
}

.secret-badge {
    background: #fff0f5;
    border-color: #ffb3d9;
}

.encryption-prompt {
    background: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

.password-form {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.password-form input {
    padding: 10px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

.error-message {
    color: #dc3545;
    margin-top: 15px;
    font-weight: bold;
}

.analysis-section {
    margin-top: 30px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.analysis-display {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    max-height: 600px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    white-space: pre-wrap;
}

.analysis-display pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.analysis-summary {
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.analysis-issue {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.analysis-issue.critical {
    background: #f8d7da;
    border-left-color: #dc3545;
}

.analysis-issue.error {
    background: #f8d7da;
    border-left-color: #dc3545;
}

.analysis-suggestion {
    background: #d1ecf1;
    border-left: 4px solid #17a2b8;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.analysis-alternative {
    background: #d4edda;
    border-left: 4px solid #28a745;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    // Initialize CodeMirror
    const languageModes = {
        'python': 'python',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'javascript': 'javascript',
        'typescript': 'text/typescript'
    };

    let editor;
    const isEncrypted = {{ 'true' if code_info.encrypted and not code_content else 'false' }};
    
    if (!isEncrypted) {
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: languageModes['{{ language }}'],
            theme: 'monokai',
            lineNumbers: true,
            readOnly: true,
            viewportMargin: Infinity
        });
    }

    // Handle decryption for encrypted files
    if (isEncrypted) {
        const decryptBtn = document.getElementById('decrypt-btn');
        const passwordInput = document.getElementById('decrypt-password');
        const errorDiv = document.getElementById('decrypt-error');
        const decryptedContent = document.getElementById('decrypted-content');
        
        async function decryptFile() {
            const password = passwordInput.value;
            
            if (!password) {
                errorDiv.textContent = 'Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.textContent = 'üîì Decrypting...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('{{ url_for("decrypt_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show decrypted content
                    document.querySelector('.encryption-prompt').style.display = 'none';
                    decryptedContent.style.display = 'block';
                    
                    // Initialize CodeMirror with decrypted content
                    const textarea = document.getElementById('code-editor');
                    textarea.value = data.content;
                    
                    editor = CodeMirror.fromTextArea(textarea, {
                        mode: languageModes['{{ language }}'],
                        theme: 'monokai',
                        lineNumbers: true,
                        readOnly: true,
                        viewportMargin: Infinity
                    });
                } else {
                    errorDiv.textContent = data.error || 'Decryption failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                decryptBtn.disabled = false;
                decryptBtn.textContent = 'Decrypt';
            }
        }
        
        decryptBtn.addEventListener('click', decryptFile);
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decryptFile();
            }
        });
    }

    // Execute code
    document.getElementById('run-code').addEventListener('click', async function() {
        const btn = this;
        const output = document.getElementById('output');
        const stdinInput = document.getElementById('stdin-input').value;
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';
        output.innerHTML = '<p class="output-loading">Executing code...</p>';

        try {
            const response = await fetch('{{ url_for("execute_code", language=language, code_id=code_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: stdinInput })
            });

            const data = await response.json();
            
            if (data.success) {
                output.innerHTML = '<pre>' + escapeHtml(data.output || 'No output') + '</pre>';
            } else {
                output.innerHTML = '<pre class="output-error">' + escapeHtml(data.error) + '</pre>';
            }
        } catch (error) {
            output.innerHTML = '<pre class="output-error">Error: ' + escapeHtml(error.message) + '</pre>';
        } finally {
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Run Code';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Delete code functionality (only used when GitHub integration is not available)
    const deleteBtn = document.getElementById('delete-code');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            if (!confirm('‚ö†Ô∏è Note: For GitHub-integrated repos, use "Delete on GitHub" button instead.\n\nThis will delete the file locally only. Continue?')) {
                return;
            }
            
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üóëÔ∏è Deleting...';
            
            try {
                const response = await fetch('{{ url_for("delete_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Code deleted successfully!');
                    window.location.href = '{{ url_for("category", language=language) }}';
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete code'));
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Delete';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete';
            }
        });
    }

    // AI Code Analysis functionality (only for C/C++)
    {% if language in ['c', 'cpp'] %}
    const analyzeBtn = document.getElementById('analyze-code');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
            const btn = this;
            const analysisSection = document.getElementById('analysis-section');
            const analysisOutput = document.getElementById('analysis-output');
            
            btn.disabled = true;
            btn.textContent = 'ü§ñ Analyzing...';
            analysisSection.style.display = 'block';
            analysisOutput.innerHTML = '<p>Analyzing your code...</p>';
            
            try {
                const response = await fetch('{{ url_for("analyze_code_route", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Format the analysis results
                    const analysis = data.analysis;
                    let html = '';
                    
                    // Summary
                    html += '<div class="analysis-summary">';
                    html += '<h4>üìä Analysis Summary</h4>';
                    html += '<p><strong>Total Issues:</strong> ' + analysis.summary.total_issues + '</p>';
                    html += '<p><strong>Critical:</strong> ' + analysis.summary.critical + ' | ';
                    html += '<strong>Errors:</strong> ' + analysis.summary.errors + ' | ';
                    html += '<strong>Warnings:</strong> ' + analysis.summary.warnings + '</p>';
                    html += '<p><strong>Suggestions:</strong> ' + analysis.summary.suggestions + '</p>';
                    html += '<p><strong>Alternative Approaches:</strong> ' + analysis.summary.alternatives + '</p>';
                    html += '</div>';
                    
                    // Issues
                    if (analysis.issues && analysis.issues.length > 0) {
                        html += '<h4>üî¥ Issues Found</h4>';
                        analysis.issues.forEach((issue, idx) => {
                            const severity = issue.severity || 'warning';
                            html += '<div class="analysis-issue ' + severity + '">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + severity.toUpperCase() + '] ' + (issue.type || 'general').toUpperCase() + '</strong></p>';
                            if (issue.line) {
                                html += '<p><em>Line: ' + issue.line + '</em></p>';
                            }
                            html += '<p>‚ö†Ô∏è ' + escapeHtml(issue.message) + '</p>';
                            html += '<p>üí° <strong>Fix:</strong> ' + escapeHtml(issue.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Suggestions
                    if (analysis.suggestions && analysis.suggestions.length > 0) {
                        html += '<h4>üí° Suggestions for Improvement</h4>';
                        analysis.suggestions.forEach((suggestion, idx) => {
                            html += '<div class="analysis-suggestion">';
                            html += '<p><strong>#' + (idx + 1) + ' [' + (suggestion.type || 'general').toUpperCase() + ']</strong></p>';
                            if (suggestion.line) {
                                html += '<p><em>Line: ' + suggestion.line + '</em></p>';
                            }
                            html += '<p>' + escapeHtml(suggestion.message) + '</p>';
                            html += '<p><strong>Suggestion:</strong> ' + escapeHtml(suggestion.suggestion) + '</p>';
                            html += '</div>';
                        });
                    }
                    
                    // Alternatives
                    if (analysis.alternatives && analysis.alternatives.length > 0) {
                        html += '<h4>üîÑ Alternative Approaches</h4>';
                        analysis.alternatives.forEach((alt, idx) => {
                            html += '<div class="analysis-alternative">';
                            html += '<p><strong>#' + (idx + 1) + ' ' + escapeHtml(alt.approach) + '</strong></p>';
                            html += '<p><strong>Benefit:</strong> ' + escapeHtml(alt.benefit) + '</p>';
                            html += '<p><strong>Example:</strong> <code>' + escapeHtml(alt.example) + '</code></p>';
                            html += '</div>';
                        });
                    }
                    
                    if (analysis.summary.total_issues === 0 && analysis.summary.suggestions === 0 && analysis.summary.alternatives === 0) {
                        html += '<p>‚úÖ No issues found! Your code looks good.</p>';
                    }
                    
                    analysisOutput.innerHTML = html;
                } else {
                    analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(data.error || 'Analysis failed') + '</p>';
                }
            } catch (error) {
                analysisOutput.innerHTML = '<p class="output-error">Error: ' + escapeHtml(error.message) + '</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ AI Code Analysis';
            }
        });
    }
    {% endif %}

</script>
{% endblock %}
