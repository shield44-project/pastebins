{% extends "base.html" %}

{% block title %}{{ code_info.title }} - {{ language|title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div class="code-viewer">
    <div class="code-header">
        <div>
            <h1>{{ code_info.title }}</h1>
            <p class="code-meta">{{ language|title }} ‚Ä¢ Created: {{ code_info.created_at[:10] }}</p>
            {% if code_info.encrypted %}
            <p class="code-meta encrypted-badge">üîí Encrypted File</p>
            {% endif %}
            {% if code_info.is_secret %}
            <p class="code-meta secret-badge">üîê Secret File</p>
            {% endif %}
            {% if code_info.description %}
            <p class="code-description">{{ code_info.description }}</p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('category', language=language) }}" class="btn btn-secondary">Back to {{ language|title }}</a>
            <a href="{{ url_for('edit_code', language=language, code_id=code_id) }}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            <button id="delete-code" class="btn btn-danger">üóëÔ∏è Delete</button>
        </div>
    </div>

    {% if code_info.encrypted and not code_content %}
    <!-- Password prompt for encrypted files -->
    <div class="encryption-prompt">
        <h2>üîí This file is encrypted</h2>
        <p>Please enter the password to view the content:</p>
        <div class="password-form">
            <input type="password" id="decrypt-password" placeholder="Enter password">
            <button id="decrypt-btn" class="btn btn-primary">Decrypt</button>
        </div>
        <div id="decrypt-error" class="error-message" style="display: none;"></div>
    </div>
    
    <div id="decrypted-content" style="display: none;">
    {% endif %}
    
    <div class="code-content">
        <h2>Code</h2>
        <div class="code-editor-wrapper">
            <textarea id="code-editor">{{ code_content if code_content else '' }}</textarea>
        </div>
    </div>

    <div class="execution-panel">
        <div class="execution-controls">
            <h2>Execute Code</h2>
            <button id="run-code" class="btn btn-primary">‚ñ∂Ô∏è Run Code</button>
        </div>
        
        <div class="input-section">
            <label for="stdin-input">Input (stdin):</label>
            <textarea id="stdin-input" placeholder="Enter input for your program (optional)"></textarea>
        </div>

        <div class="output-section">
            <h3>Output</h3>
            <div id="output" class="output-display">
                <p class="output-placeholder">Click "Run Code" to see the output</p>
            </div>
        </div>
    </div>
    
    {% if code_info.encrypted and not code_content %}
    </div>
    {% endif %}
</div>

<style>
.encrypted-badge, .secret-badge {
    display: inline-block;
    padding: 5px 10px;
    background: #f0f8ff;
    border: 1px solid #b3d9ff;
    border-radius: 4px;
    font-weight: bold;
    margin-top: 5px;
}

.secret-badge {
    background: #fff0f5;
    border-color: #ffb3d9;
}

.encryption-prompt {
    background: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

.password-form {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.password-form input {
    padding: 10px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

.error-message {
    color: #dc3545;
    margin-top: 15px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    // Initialize CodeMirror
    const languageModes = {
        'python': 'python',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'javascript': 'javascript',
        'typescript': 'text/typescript'
    };

    let editor;
    const isEncrypted = {{ 'true' if code_info.encrypted and not code_content else 'false' }};
    
    if (!isEncrypted) {
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: languageModes['{{ language }}'],
            theme: 'monokai',
            lineNumbers: true,
            readOnly: true,
            viewportMargin: Infinity
        });
    }

    // Handle decryption for encrypted files
    if (isEncrypted) {
        const decryptBtn = document.getElementById('decrypt-btn');
        const passwordInput = document.getElementById('decrypt-password');
        const errorDiv = document.getElementById('decrypt-error');
        const decryptedContent = document.getElementById('decrypted-content');
        
        async function decryptFile() {
            const password = passwordInput.value;
            
            if (!password) {
                errorDiv.textContent = 'Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.textContent = 'üîì Decrypting...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('{{ url_for("decrypt_code", language=language, code_id=code_id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show decrypted content
                    document.querySelector('.encryption-prompt').style.display = 'none';
                    decryptedContent.style.display = 'block';
                    
                    // Initialize CodeMirror with decrypted content
                    const textarea = document.getElementById('code-editor');
                    textarea.value = data.content;
                    
                    editor = CodeMirror.fromTextArea(textarea, {
                        mode: languageModes['{{ language }}'],
                        theme: 'monokai',
                        lineNumbers: true,
                        readOnly: true,
                        viewportMargin: Infinity
                    });
                } else {
                    errorDiv.textContent = data.error || 'Decryption failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                decryptBtn.disabled = false;
                decryptBtn.textContent = 'Decrypt';
            }
        }
        
        decryptBtn.addEventListener('click', decryptFile);
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decryptFile();
            }
        });
    }

    // Execute code
    document.getElementById('run-code').addEventListener('click', async function() {
        const btn = this;
        const output = document.getElementById('output');
        const stdinInput = document.getElementById('stdin-input').value;
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';
        output.innerHTML = '<p class="output-loading">Executing code...</p>';

        try {
            const response = await fetch('{{ url_for("execute_code", language=language, code_id=code_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: stdinInput })
            });

            const data = await response.json();
            
            if (data.success) {
                output.innerHTML = '<pre>' + escapeHtml(data.output || 'No output') + '</pre>';
            } else {
                output.innerHTML = '<pre class="output-error">' + escapeHtml(data.error) + '</pre>';
            }
        } catch (error) {
            output.innerHTML = '<pre class="output-error">Error: ' + escapeHtml(error.message) + '</pre>';
        } finally {
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Run Code';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Delete code functionality
    document.getElementById('delete-code').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this code file? This action cannot be undone.')) {
            return;
        }
        
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'üóëÔ∏è Deleting...';
        
        try {
            const response = await fetch('{{ url_for("delete_code", language=language, code_id=code_id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Code deleted successfully!');
                window.location.href = '{{ url_for("category", language=language) }}';
            } else {
                alert('Error: ' + (data.error || 'Failed to delete code'));
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete';
            }
        } catch (error) {
            alert('Error: ' + error.message);
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è Delete';
        }
    });

</script>
{% endblock %}
