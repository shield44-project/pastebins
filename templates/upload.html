{% extends "base.html" %}

{% block title %}{% if edit_mode %}Edit Code{% else %}Upload Code{% endif %}{% endblock %}

{% block content %}
<div class="upload-page">
    <h1>{% if edit_mode %}Edit Code{% else %}Upload New Code{% endif %}</h1>
    
    {% if error %}
    <div class="error-message">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}
    
    {% if not edit_mode %}
    <!-- Tab navigation -->
    <div class="upload-tabs">
        <button class="tab-btn active" onclick="switchTab('paste')">üìù Paste Code</button>
        <button class="tab-btn" onclick="switchTab('files')">üìÅ Upload Files</button>
    </div>
    {% endif %}
    
    <!-- Paste Code Tab (or Edit Form) -->
    <form method="POST" action="{% if edit_mode %}{{ url_for('edit_code', language=language, code_id=code_id) }}{% else %}{{ url_for('upload_code') }}{% endif %}" class="upload-form" id="pasteForm">
        <div class="form-group">
            <label for="language">Language *</label>
            <select name="language" id="language" required {% if edit_mode %}disabled{% endif %}>
                <option value="">Select Language</option>
                <option value="python" {% if edit_mode and language == 'python' %}selected{% endif %}>Python</option>
                <option value="java" {% if edit_mode and language == 'java' %}selected{% endif %}>Java</option>
                <option value="c" {% if edit_mode and language == 'c' %}selected{% endif %}>C</option>
                <option value="cpp" {% if edit_mode and language == 'cpp' %}selected{% endif %}>C++</option>
                <option value="html" {% if edit_mode and language == 'html' %}selected{% endif %}>HTML/Website</option>
            </select>
            {% if edit_mode %}
            <input type="hidden" name="language" value="{{ language }}">
            <p class="help-text">Language cannot be changed when editing</p>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="title">Title *</label>
            <input type="text" name="title" id="title" required placeholder="e.g., Hello World" {% if edit_mode %}value="{{ code_info.title }}"{% endif %}>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea name="description" id="description" rows="3" placeholder="Brief description of your code">{% if edit_mode %}{{ code_info.description }}{% endif %}</textarea>
        </div>

        <div class="form-group">
            <label for="code">Code *</label>
            <textarea name="code" id="code" required rows="20" placeholder="Paste your code here...">{% if edit_mode %}{{ code_content }}{% endif %}</textarea>
        </div>

        {% if not edit_mode %}
        <!-- Encryption Options -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="encrypt" id="encrypt" onchange="toggleEncryption('paste')">
                üîí Encrypt this file with password
            </label>
        </div>

        <div class="form-group encryption-fields" id="pasteEncryptionFields" style="display: none;">
            <label for="password">Encryption Password *</label>
            <input type="password" name="password" id="password" placeholder="Enter encryption password">
            <p class="help-text">‚ö†Ô∏è Remember this password! You'll need it to view the file later.</p>
        </div>

        <!-- Secret Folder Option -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_secret" id="is_secret">
                üîê Mark as secret (hidden from public view)
            </label>
            <p class="help-text">Secret files will only be visible in the "Secret Folders" section.</p>
        </div>

        {% endif %}

        <div class="form-actions">
            {% if edit_mode %}
            <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            {% else %}
            <button type="submit" name="submit_action" value="upload" class="btn btn-primary">üì§ Upload Code</button>
            <button type="submit" name="submit_action" value="upload_github" class="btn btn-github">üìÇ Upload & Push to GitHub</button>
            {% endif %}
            <a href="{% if edit_mode %}{{ url_for('view_code', language=language, code_id=code_id) }}{% else %}/{% endif %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    
    {% if not edit_mode %}
    <form method="POST" action="{{ url_for('upload_files') }}" enctype="multipart/form-data" class="upload-form" id="filesForm" style="display: none;">
        <div class="form-group">
            <label for="file_language">Language *</label>
            <select name="language" id="file_language" required>
                <option value="">Select Language</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="c">C</option>
                <option value="cpp">C++</option>
                <option value="html">HTML/Website</option>
            </select>
        </div>

        <div class="form-group">
            <label for="files">Select Files *</label>
            <input type="file" name="files" id="files" multiple required accept=".py,.java,.c,.cpp,.html">
            <p class="help-text">You can select multiple files at once. Files will be uploaded with their original names.</p>
        </div>

        <div id="filePreview" class="file-preview"></div>

        <!-- Encryption Options -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="encrypt" id="encrypt_files" onchange="toggleEncryption('files')">
                üîí Encrypt files with password
            </label>
        </div>

        <div class="form-group encryption-fields" id="filesEncryptionFields" style="display: none;">
            <label for="password_files">Encryption Password *</label>
            <input type="password" name="password" id="password_files" placeholder="Enter encryption password">
            <p class="help-text">‚ö†Ô∏è Remember this password! You'll need it to view the files later.</p>
        </div>

        <!-- Secret Folder Option -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_secret" id="is_secret_files">
                üîê Mark as secret (hidden from public view)
            </label>
            <p class="help-text">Secret files will only be visible in the "Secret Folders" section.</p>
        </div>


        <div class="form-actions">
            <button type="submit" name="submit_action" value="upload" class="btn btn-primary">üì§ Upload Files</button>
            <button type="submit" name="submit_action" value="upload_github" class="btn btn-github">üìÇ Upload Files & Push to GitHub</button>
            <a href="/" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    {% endif %}
</div>

<style>
.error-message {
    background: #fee;
    border: 1px solid #fcc;
    border-left: 4px solid #f44;
    color: #c33;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    font-size: 14px;
}

.error-message strong {
    font-weight: 600;
}

.upload-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.tab-btn {
    background: none;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 16px;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn:hover {
    color: #333;
}

.tab-btn.active {
    color: #007bff;
    border-bottom-color: #007bff;
}

.help-text {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.file-preview {
    margin-top: 15px;
}

.file-preview-item {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-preview-item .file-icon {
    font-size: 20px;
}

.file-preview-item .file-name {
    flex: 1;
    font-weight: 500;
}

.file-preview-item .file-size {
    color: #666;
    font-size: 14px;
}

.encryption-fields {
    padding: 15px;
    background: #f0f8ff;
    border: 1px solid #b3d9ff;
    border-radius: 5px;
    margin-top: 10px;
}

.encryption-fields input[type="password"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.btn-github {
    background: linear-gradient(135deg, #6e5494, #5a4374);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-github:hover {
    background: linear-gradient(135deg, #5a4374, #4a3364);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(110, 84, 148, 0.4);
}

.form-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}
</style>

<script>
function toggleEncryption(formType) {
    if (formType === 'paste') {
        const checkbox = document.getElementById('encrypt');
        const fields = document.getElementById('pasteEncryptionFields');
        const passwordInput = document.getElementById('password');
        
        if (checkbox.checked) {
            fields.style.display = 'block';
            passwordInput.required = true;
        } else {
            fields.style.display = 'none';
            passwordInput.required = false;
            passwordInput.value = '';
        }
    } else if (formType === 'files') {
        const checkbox = document.getElementById('encrypt_files');
        const fields = document.getElementById('filesEncryptionFields');
        const passwordInput = document.getElementById('password_files');
        
        if (checkbox.checked) {
            fields.style.display = 'block';
            passwordInput.required = true;
        } else {
            fields.style.display = 'none';
            passwordInput.required = false;
            passwordInput.value = '';
        }
    }
}

function switchTab(tab) {
    const pasteForm = document.getElementById('pasteForm');
    const filesForm = document.getElementById('filesForm');
    const tabs = document.querySelectorAll('.tab-btn');
    
    tabs.forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'paste') {
        pasteForm.style.display = 'block';
        filesForm.style.display = 'none';
        tabs[0].classList.add('active');
    } else {
        pasteForm.style.display = 'none';
        filesForm.style.display = 'block';
        tabs[1].classList.add('active');
    }
}

// File preview
document.getElementById('files')?.addEventListener('change', function(e) {
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '';
    
    if (e.target.files.length > 0) {
        const header = document.createElement('h3');
        header.textContent = 'Selected Files:';
        header.style.marginBottom = '10px';
        preview.appendChild(header);
        
        Array.from(e.target.files).forEach(file => {
            const item = document.createElement('div');
            item.className = 'file-preview-item';
            
            const icon = document.createElement('span');
            icon.className = 'file-icon';
            icon.textContent = 'üìÑ';
            
            const name = document.createElement('span');
            name.className = 'file-name';
            name.textContent = file.name;
            
            const size = document.createElement('span');
            size.className = 'file-size';
            size.textContent = formatFileSize(file.size);
            
            item.appendChild(icon);
            item.appendChild(name);
            item.appendChild(size);
            
            preview.appendChild(item);
        });
    }
});

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}
</script>
{% endblock %}
